# Complete swissarmyhammer-common Domain Crate Migration Cleanup

## Problem
Another incomplete migration has been identified. The `swissarmyhammer-common` domain crate exists with shared functionality, but the **duplicate code was never removed** from the main `swissarmyhammer` crate, following the same pattern as search and issues migrations.

## Evidence of Incomplete Migration

### **Duplicate Common Code Found:**

#### **swissarmyhammer/src/common/** (12 files - Should be removed)
- `abort_utils.rs` - Duplicate of `swissarmyhammer-common/src/abort_utils.rs`
- `env_loader.rs` - Duplicate of `swissarmyhammer-common/src/env_loader.rs`
- `error_context.rs` - Common error utilities
- `file_types.rs` - File type utilities  
- `interactive_prompts.rs` - Interactive prompt utilities
- `mcp_errors.rs` - MCP error handling
- `parameter_cli.rs` - CLI parameter handling
- `parameter_conditions.rs` - Parameter condition logic
- `parameters.rs` - Parameter system
- `ulid_generator.rs` - ULID generation (duplicate of `swissarmyhammer-common/src/utils/ulid_generator.rs`)
- `validation_builders.rs` - Validation utilities
- `mod.rs` - Module organization

#### **swissarmyhammer-common/src/** (13 files - Domain crate)
- Similar/equivalent functionality in organized structure
- `abort_utils.rs`, `env_loader.rs`, `error.rs`, etc.
- `utils/ulid_generator.rs`, `utils/directory_utils.rs`, etc.

## Current Problematic State
1. **✅ swissarmyhammer-common domain crate** exists and is functional
2. **❌ swissarmyhammer/src/common/** still exists with duplicate code
3. **❌ Potential circular dependencies** if main crate depends on common crate
4. **❌ Code duplication** and maintenance burden

## Evidence of Usage
The main crate still has import from its own common module:
```rust
use swissarmyhammer::common::file_types::{is_any_prompt_file, is_prompt_file};
```
Found in `swissarmyhammer-tools/src/mcp/file_watcher.rs:7`

This should be:
```rust
use swissarmyhammer_common::file_types::{is_any_prompt_file, is_prompt_file};
```

## Implementation Plan

### Phase 1: Verify Domain Crate Completeness
- [ ] Review `swissarmyhammer-common` to ensure it has all functionality from `swissarmyhammer/src/common/`
- [ ] Map each file in main crate common to equivalent in domain crate
- [ ] Identify any missing functionality that needs to be added to domain crate
- [ ] Ensure API compatibility between old and new versions

### Phase 2: Update swissarmyhammer-tools
- [ ] Fix the remaining common import:
  ```rust
  // FROM: use swissarmyhammer::common::file_types::{is_any_prompt_file, is_prompt_file};
  // TO:   use swissarmyhammer_common::file_types::{is_any_prompt_file, is_prompt_file};
  ```
- [ ] Update any other usage of `swissarmyhammer::common` imports
- [ ] Verify functionality still works with domain crate

### Phase 3: Update Other Consumers
- [ ] Check if any other crates import from `swissarmyhammer::common`
- [ ] Update all consumers to use `swissarmyhammer_common` domain crate
- [ ] Verify no other components depend on main crate common module

### Phase 4: Remove Duplicate Code from Main Crate  
- [ ] Remove `swissarmyhammer/src/common/` directory entirely:
  - `abort_utils.rs`
  - `env_loader.rs`
  - `error_context.rs`
  - `file_types.rs`
  - `interactive_prompts.rs`
  - `mcp_errors.rs`
  - `parameter_cli.rs`
  - `parameter_conditions.rs`
  - `parameters.rs`
  - `ulid_generator.rs`
  - `validation_builders.rs`
  - `mod.rs`
- [ ] Update `swissarmyhammer/src/lib.rs` to remove common module exports
- [ ] Remove any common-related re-exports from main crate

### Phase 5: Clean Up Dependencies
- [ ] Ensure main crate properly depends on `swissarmyhammer-common` for shared functionality
- [ ] Remove any duplicate dependencies from main crate if they're now in common crate
- [ ] Verify no circular dependencies exist
- [ ] Update Cargo.toml dependencies appropriately

### Phase 6: Verification
- [ ] Build entire workspace to ensure no breakage
- [ ] Run all tests to verify common functionality still works
- [ ] Verify file type utilities, abort utils, env loading still work
- [ ] Check that parameter system and validation work correctly
- [ ] Ensure no circular dependencies exist

## COMPLETION CRITERIA - How to Know This Issue is REALLY Done

**This issue is complete when:**

1. **`swissarmyhammer/src/common/` directory no longer exists**
2. **This import in swissarmyhammer-tools is updated:**
   ```bash
   # Should return ZERO results:
   rg "use swissarmyhammer::common" swissarmyhammer-tools/
   
   # Should find new import:
   rg "use swissarmyhammer_common" swissarmyhammer-tools/
   ```

## Expected Impact
- **Eliminate duplicate common code** in main crate (~12 files)
- **Fix remaining common dependency** in swissarmyhammer-tools
- **Reduce main crate size** significantly
- **Complete common domain separation**

## Success Criteria
- [ ] `swissarmyhammer/src/common/` no longer exists
- [ ] swissarmyhammer-tools imports from `swissarmyhammer_common` not `swissarmyhammer::common`
- [ ] All common functionality preserved and working
- [ ] No duplicate code between main crate and common crate
- [ ] No circular dependencies
- [ ] Workspace builds and tests pass

## Risk Mitigation
- Map all common functionality carefully before removal
- Test common utilities thoroughly after migration
- Ensure all parameter, validation, and utility functions work
- Keep migration changes granular for easy rollback
- Verify no hidden dependencies on main crate common code

## Notes
This follows the exact same pattern as search and issues migrations - the domain crate was created and functional, but the cleanup phase was never completed. This creates duplicate code, potential circular dependencies, and confusion about which common utilities to use.

Completing this migration will eliminate another area of duplication and ensure clean domain separation for common utilities.